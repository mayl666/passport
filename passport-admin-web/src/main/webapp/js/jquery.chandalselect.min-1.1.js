/**
* 作者：陈守玉
* Email：chshouyu@126.com
* 时间：2012-11-05
* version：1.1
*/
(function($){$.fn.chandalSelect=function(options){var defaults={inputWidth:120,inputHeight:20,listMaxHeight:200,onChange:null};var opts=$.extend({},defaults,options);return this.each(function(){var _this=$(this),_lis=[],_newLis=[],_index=-1,_options,_oldVal=_this.val(),keyList=[9,13,27,35,36,37,38,39,40];function inKeyList(key){for(var i=0;i<keyList.length;i++){if(keyList[i]===key){return true}}return false}function initList(){_options=_this.find("option");if(_options.length>0){_lis.length=0;for(var i=0;i<_options.length;i++){_lis.push('<li val="'+$(_options[i]).attr("value")+'">'+$(_options[i]).text()+'</li>')}}}var _html='<div class="chandal-selector"><p class="chandal-tip">您所填的值不存在！<span class="chandal-arrow-out"></span><span class="chandal-arrow-in"></span></p><input type="text" class="chandal-input" style="width:'+opts.inputWidth+'px; height:'+opts.inputHeight+'px;line-height:'+opts.inputHeight+'px;" /><div class="chandal-list-wrapper" style="width:'+(opts.inputWidth+4)+'px;top:'+(opts.inputHeight+6)+'px"><ul class="chandal-data-list" style="max-height:'+opts.listMaxHeight+'px"></ul></div></div>';_this.after(_html);var chandalSelector=_this.next(".chandal-selector"),dataList=chandalSelector.find(".chandal-data-list"),dataListWrapper=chandalSelector.find(".chandal-list-wrapper"),inputItem=chandalSelector.find(".chandal-input"),allListWrapper=$(".chandal-list-wrapper"),errorTip=chandalSelector.find(".chandal-tip");inputItem.focus(function(){$(".chandal-list-wrapper").hide();initList();if(_lis.length>0){dataList.html(_lis.join(""));dataListWrapper.show();dataList.scrollTop(0)}}).keyup(function(e){if(_options.length>0){var keyCode=e.keyCode;if(!inKeyList(keyCode)){if(keyCode===8){_index=-1}var _val=inputItem.val();_newLis.length=0;if(_val.length>0){for(var i=0;i<_options.length;i++){var _elem=_options.eq(i);if(_elem.text().indexOf(_val)!=-1){var reg=new RegExp(_val,"g");_newLis.push('<li val="'+_elem.attr("value")+'">'+_elem.text().replace(reg,"<span style='color:red;'>"+_val+"</span>")+'</li>')}}if(_newLis.length>0){dataList.html(_newLis.join(""));dataListWrapper.show()}else{dataList.html(_lis.join(""));dataListWrapper.show()}}else{allListWrapper.hide();_index=-1}}else if(keyCode===40){if(dataListWrapper.is(":visible")){_index=(_index+1)%dataList.find("li").length;dataList.find("li").removeClass("selected").eq(_index).addClass("selected");inputItem.val(dataList.find("li.selected").text())}}else if(keyCode===38){if(dataListWrapper.is(":visible")){_index-=1;if(_index<0){_index=dataList.find("li").length-1}dataList.find("li").removeClass("selected").eq(_index).addClass("selected");inputItem.val(dataList.find("li.selected").text())}}else if(keyCode===13){_this.val(dataList.find("li.selected").attr("val"));inputItem.val(dataList.find("li.selected").text()).blur();if(_this.val()!=_oldVal){_oldVal=_this.val();if(opts.onChange){opts.onChange(_this.val(),inputItem.val())}}dataListWrapper.hide();_index=-1}else if(keyCode===27){}}}).blur(function(){setTimeout(function(){if(inputItem.val().length>0){var exVal;for(var i=0;i<_lis.length;i++){if($(_lis[i]).text()==inputItem.val()){exVal=$(_lis[i]).attr("val");break}}if(exVal===undefined){errorTip.show();_this.val("")}else if(exVal!==_this.val()){_this.val(exVal);errorTip.hide();if(_this.val()!=_oldVal){_oldVal=_this.val();if(opts.onChange){opts.onChange(_this.val(),inputItem.val())}}}else{errorTip.hide()}}},100)});chandalSelector.delegate("li","click",function(){errorTip.hide();_this.val($(this).attr("val"));inputItem.val($(this).text());if(_this.val()!=_oldVal){_oldVal=_this.val();if(opts.onChange){opts.onChange(_this.val(),inputItem.val())}}dataListWrapper.hide();_index=-1});$(document).click(function(e){var elem=e.target;while(elem){if($(elem).hasClass("chandal-list-wrapper")||$(elem).hasClass("chandal-input")){return}elem=elem.parentNode}allListWrapper.hide();_index=-1})})}})(jQuery);